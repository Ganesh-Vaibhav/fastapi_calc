# docker-compose.yml
version: '3.8'

services:
  # ---------------------------------------------
  # Service: web (Your FastAPI App)
  # (Your original configuration - this is great!)
  # ---------------------------------------------
  web:
    build: .
    container_name: fastapi_calculator
    ports:
      - "8000:8000"
    volumes:
      - .:/app
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    # This 'depends_on' is new! It tells Docker to start the 'db'
    # service *before* starting the 'web' service.
    depends_on:
      - db

  # ---------------------------------------------
  # Service: db (The PostgreSQL Database)
  # (This section is NEW and REQUIRED for the assignment)
  # ---------------------------------------------
  db:
    image: postgres:15-alpine  # Use an official PostgreSQL image
    container_name: fastapi_db_postgres
    environment:
      # These variables create the database and user
      # as required by your assignment instructions.
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=mysecretpassword  # You can change this
      - POSTGRES_DB=fastapi_db
    volumes:
      # This volume persists your database data even if the
      # container is stopped or removed.
      - postgres_data:/var/lib/postgresql/data
    ports:
      # This maps the default PostgreSQL port (5432) inside the
      # container to port 5432 on your host machine.
      # This is optional but useful for connecting other tools.
      - "5432:5432"

  # ---------------------------------------------
  # Service: pgadmin (The Database GUI)
  # (This section is NEW and REQUIRED for the assignment)
  # ---------------------------------------------
  pgadmin:
    image: dpage/pgadmin4
    container_name: pgadmin_server
    environment:
      # These are the credentials you will use to log in
      # to the pgAdmin *web interface* at http://localhost:5050
      - PGADMIN_DEFAULT_EMAIL=admin@example.com
      - PGADMIN_DEFAULT_PASSWORD=adminpassword  # You can change this
    ports:
      # Maps the port specified in your assignment (5050)
      # to the default pgAdmin port (80) inside the container.
      - "5050:80"
    depends_on:
      # This ensures pgAdmin doesn't start until the 'db'
      # service is already up and running.
      - db

# ---------------------------------------------
# Volumes Definition
# (This top-level key is NEW)
# ---------------------------------------------
# This defines the named volume we used in the 'db' service
# to make sure our database data is saved.
volumes:
  postgres_data: